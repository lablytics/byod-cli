import{r as p,j as e,m as u,p as W,u as J,b as G,c as N,d as H,L as V,A as K,e as O,f as Y}from"./index-B8SBTCI8.js";import{a as D,b as Z}from"./Skeleton-Cg_dwXAZ.js";import{u as U,P as Q}from"./ProgressTracker-4PGVOIMw.js";function L(n){if(n===0)return"0 B";const i=["B","KB","MB","GB"],a=Math.floor(Math.log(n)/Math.log(1024));return`${(n/Math.pow(1024,a)).toFixed(a===0?0:1)} ${i[a]}`}function X({onFilesSelect:n,files:i,onClear:a,onRemove:g,accept:h,multiple:c=!0}){const[l,x]=p.useState(!1),o=p.useRef(null),j=p.useCallback(s=>{s.preventDefault(),x(!1);const d=Array.from(s.dataTransfer.files);d.length>0&&n(c?[...i,...d]:[d[0]])},[n,i,c]),m=p.useCallback(s=>{const d=Array.from(s.target.files||[]);d.length>0&&n(c?[...i,...d]:[d[0]]),s.target.value=""},[n,i,c]),v=i.reduce((s,d)=>s+d.size,0);return i.length>0?e.jsxs("div",{className:"file-drop-zone has-files",children:[e.jsx("div",{className:"file-list",children:i.map((s,d)=>e.jsxs("div",{className:"file-item",children:[e.jsxs("div",{className:"file-info",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"var(--accent)",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14,2 14,8 20,8"})]}),e.jsx("span",{className:"file-name",children:s.name}),e.jsx("span",{className:"file-size",children:L(s.size)})]}),e.jsx("button",{className:"file-remove",onClick:()=>g(d),title:"Remove file",children:"×"})]},`${s.name}-${d}`))}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 16px",borderTop:"1px solid var(--border)",fontSize:"12px",color:"var(--text-dim)"},children:[e.jsxs("span",{children:[i.length," file",i.length!==1?"s":""," (",L(v),")"]}),e.jsxs("div",{style:{display:"flex",gap:"12px"},children:[c&&e.jsx("button",{onClick:()=>{var s;return(s=o.current)==null?void 0:s.click()},style:{background:"none",border:"none",color:"var(--accent)",cursor:"pointer",fontSize:"12px",padding:0},children:"+ Add more"}),e.jsx("button",{onClick:a,style:{background:"none",border:"none",color:"var(--red)",cursor:"pointer",fontSize:"12px",padding:0},children:"Clear all"})]})]}),e.jsx("input",{ref:o,type:"file",style:{display:"none"},accept:h,multiple:c,onChange:m})]}):e.jsxs("div",{className:`file-drop-zone ${l?"dragging":""}`,onDragOver:s=>{s.preventDefault(),x(!0)},onDragLeave:()=>x(!1),onDrop:j,onClick:()=>{var s;return(s=o.current)==null?void 0:s.click()},children:[e.jsx("input",{ref:o,type:"file",style:{display:"none"},accept:h,multiple:c,onChange:m}),e.jsxs("div",{className:"drop-zone-content",children:[e.jsxs("svg",{className:"drop-zone-icon",width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"17,8 12,3 7,8"}),e.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"drop-zone-primary",children:["Drop your file",c?"s":""," here or click to browse"]}),e.jsx("div",{className:"drop-zone-secondary",children:c?"Select one or more files":"Supports any file format"})]}),e.jsx("div",{className:"drop-zone-hint",children:"Files will be encrypted locally with AES-256-GCM before upload"})]})]})}function _(){return e.jsxs("div",{className:"security-notice",style:{borderLeft:"3px solid rgba(34, 197, 94, 0.4)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"4px"},children:[e.jsxs(u.svg,{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"var(--green)",strokeWidth:"2",variants:W,animate:"animate","aria-hidden":"true",children:[e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),e.jsx("path",{d:"M9 12l2 2 4-4"})]}),e.jsx("strong",{children:"Zero-knowledge encryption"})]}),e.jsx("span",{style:{color:"var(--text-dim)"},children:"Your data is encrypted on this machine using your AWS KMS key before upload. Neither Lablytics nor anyone else can access your plaintext data. Only the cryptographically attested Nitro Enclave can decrypt it for processing."})]})}function ee(n){if(!n)return{accept:void 0,hint:void 0};const i=[];for(const a of n)if(a.type==="file")if(a.formats)for(const g of a.formats)i.push(`.${g.toLowerCase()}`);else a.pattern&&a.pattern.toLowerCase().includes("fastq")&&i.push(".fastq",".fastq.gz",".fq",".fq.gz");return i.length===0?{accept:void 0,hint:void 0}:{accept:i.join(","),hint:`Accepts: ${i.join(", ")}`}}function se(n,i){if(!i)return[];const a=i.filter(h=>h.type==="file");if(a.length===0)return[];const g=[];for(const h of n){const c=h.name.toLowerCase();let l=!1;for(const x of a)if(x.formats){const o=c.split(".").pop()||"";if(x.formats.some(m=>m.toLowerCase()===o)){l=!0;break}const j=c.split(".");if(j.length>=3){const m=j.slice(-2).join(".");if(x.formats.some(v=>v.toLowerCase()===m)){l=!0;break}}}else if(x.pattern){if(te(c,x.pattern.toLowerCase())){l=!0;break}}else{l=!0;break}l||g.push(h.name)}return g}function te(n,i){return new RegExp("^"+i.replace(/[.+^${}()|[\]\\]/g,"\\$&").replace(/\*/g,".*").replace(/\?/g,".")+"$").test(n)}const $=["Pipeline","Files","Review"];function ae(){const[n,i]=p.useState(0),[a,g]=p.useState(1),[h,c]=p.useState([]),[l,x]=p.useState(""),[o,j]=p.useState([]),[m,v]=p.useState(""),[s,d]=p.useState(null),[E,A]=p.useState(!0),I=J(),f=U();p.useEffect(()=>{D("/status").then(d).catch(()=>{}).finally(()=>A(!1))},[]);const k=(s==null?void 0:s.authenticated)&&(s==null?void 0:s.tenant_valid)&&(s==null?void 0:s.kms_key_configured)&&(s==null?void 0:s.role_configured);p.useEffect(()=>{k&&D("/plugins").then(c).catch(()=>{})},[k]);const C=()=>{g(1),i(t=>Math.min(t+1,$.length-1))},B=()=>{g(-1),i(t=>Math.max(t-1,0))},R=t=>{j(r=>r.filter((b,q)=>q!==t))},T=async()=>{if(o.length===0||!l)return;const t=new FormData;for(const r of o)t.append("files",r);t.append("plugin",l),t.append("description",m),f.start("/api/submit",{method:"POST",body:t})},F=o.reduce((t,r)=>t+r.size,0),S=a>0?O:Y,y=h.find(t=>t.name===l),{accept:P,hint:M}=ee(y==null?void 0:y.inputs),w=se(o,y==null?void 0:y.inputs);if(f.result){const t=f.result;return e.jsxs(u.div,{className:"success-content",variants:G,initial:"initial",animate:"animate",children:[e.jsxs(u.div,{className:"success-icon confetti-container",variants:N,children:[e.jsxs("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"var(--green)",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx(u.path,{d:"M9 12l2 2 4-4",variants:H,initial:"initial",animate:"animate"})]}),[{color:"var(--green)",target:"translate(-30px, -30px) scale(1)"},{color:"var(--accent)",target:"translate(30px, -25px) scale(1)"},{color:"var(--yellow)",target:"translate(-25px, 30px) scale(1)"},{color:"var(--blue)",target:"translate(35px, 20px) scale(1)"},{color:"var(--green)",target:"translate(0px, -35px) scale(1)"},{color:"var(--accent)",target:"translate(-35px, 5px) scale(1)"}].map((r,b)=>e.jsx("span",{className:"confetti-particle",style:{background:r.color,top:"50%",left:"50%",animationDelay:`${b*.08}s`,"--confetti-target":r.target}},b))]}),e.jsx(u.h2,{variants:N,children:"Job Submitted!"}),e.jsx(u.div,{className:"job-id",variants:N,children:e.jsx("code",{style:{background:"var(--surface)",padding:"4px 12px",borderRadius:"6px",border:"1px solid var(--border)"},children:t.job_id})}),e.jsx(u.p,{variants:N,style:{color:"var(--text-dim)",marginBottom:"24px"},children:"Your data was encrypted locally and submitted for processing."}),e.jsxs(u.div,{className:"success-actions",variants:N,children:[e.jsx("button",{className:"btn-primary",onClick:()=>I(`/jobs/${t.job_id}`),children:"View Job"}),e.jsx("button",{className:"btn-secondary",onClick:()=>{f.reset(),i(0),j([]),x(""),v("")},children:"Submit Another"})]})]})}if(f.active||f.error)return e.jsxs("div",{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Submitting Job"}),e.jsx("p",{children:"Encrypting and uploading your data..."})]}),e.jsx(_,{}),e.jsx(Q,{progress:f.progress,error:f.error,label:"Submission Progress"}),f.error&&e.jsx("div",{style:{marginTop:"16px"},children:e.jsx("button",{className:"btn-secondary",onClick:f.reset,children:"Try Again"})})]});if(E)return e.jsxs("div",{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Submit Job"}),e.jsx("p",{children:"Encrypt and submit data for secure processing"})]}),e.jsx(Z,{items:4})]});if(!k){const t=[];return s!=null&&s.authenticated||t.push("Not authenticated"),s!=null&&s.authenticated&&!(s!=null&&s.tenant_valid)&&t.push((s==null?void 0:s.tenant_error)||"Tenant is not active"),s!=null&&s.kms_key_configured||t.push((s==null?void 0:s.kms_key_error)||"KMS key not configured"),s!=null&&s.role_configured||t.push((s==null?void 0:s.role_error)||"IAM role not configured"),e.jsxs("div",{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Submit Job"}),e.jsx("p",{children:"Encrypt and submit data for secure processing"})]}),e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"48px 24px"},children:[e.jsxs("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"var(--yellow)",strokeWidth:"2",style:{marginBottom:"16px"},children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]}),e.jsx("h2",{style:{marginBottom:"8px"},children:"Setup Required"}),e.jsx("p",{style:{color:"var(--text-dim)",marginBottom:"20px",maxWidth:"400px",margin:"0 auto 20px"},children:"All prerequisites must be met before you can submit jobs."}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"8px",alignItems:"center",marginBottom:"24px"},children:t.map(r=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",fontSize:"14px",color:"var(--red)"},children:[e.jsx("span",{style:{fontSize:"12px"},children:"✗"}),r]},r))}),e.jsx(V,{to:"/setup",className:"btn-primary",style:{textDecoration:"none"},children:"Go to Setup"})]})]})}return e.jsxs("div",{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Submit Job"}),e.jsx("p",{children:"Encrypt and submit data for secure processing"})]}),e.jsx("div",{className:"wizard-steps",children:$.map((t,r)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[r>0&&e.jsx("div",{className:"step-connector"}),e.jsxs("div",{className:`wizard-step ${r===n?"active":r<n?"completed":""}`,children:[e.jsx("div",{className:"step-number",children:r<n?"✓":r+1}),e.jsx("span",{className:"step-label",children:t})]})]},t))}),e.jsx("div",{className:"wizard-content",children:e.jsxs(K,{mode:"wait",children:[n===0&&e.jsxs(u.div,{variants:S,initial:"initial",animate:"animate",exit:"exit",className:"step-content",children:[e.jsx("h2",{children:"Select Pipeline"}),e.jsx("p",{children:"Choose the analysis pipeline for your data"}),h.length===0?e.jsx("div",{className:"loading",children:"Loading pipelines..."}):e.jsx("div",{className:"pipeline-grid",children:h.map(t=>{var r;return e.jsxs("div",{className:`pipeline-card ${l===t.name?"selected":""}`,onClick:()=>x(t.name),children:[e.jsx("h3",{children:t.name}),e.jsx("div",{className:"desc",children:t.description}),(r=t.tags)==null?void 0:r.map(b=>e.jsx("span",{className:"tag",children:b},b)),t.input_type&&e.jsxs("div",{style:{marginTop:"8px",fontSize:"12px",color:"var(--text-dim)"},children:["Input: ",t.input_type]})]},t.name)})}),e.jsx("div",{className:"step-actions",children:e.jsx("button",{className:"btn-primary",disabled:!l,onClick:C,children:"Continue"})})]},"step-0"),n===1&&e.jsxs(u.div,{variants:S,initial:"initial",animate:"animate",exit:"exit",className:"step-content",children:[e.jsx("h2",{children:"Upload Files"}),e.jsx("p",{children:"Select the file(s) you want to process"}),e.jsx(X,{files:o,onFilesSelect:j,onClear:()=>j([]),onRemove:R,accept:P}),M&&e.jsx("div",{style:{marginTop:"8px",fontSize:"13px",color:"var(--text-dim)"},children:M}),w.length>0&&e.jsxs("div",{style:{marginTop:"8px",padding:"12px",background:"rgba(239, 68, 68, 0.1)",border:"1px solid var(--red)",borderRadius:"8px",fontSize:"13px",color:"var(--red)"},children:[e.jsx("strong",{children:"Invalid file types:"})," ",w.join(", ")]}),e.jsxs("div",{className:"input-group",style:{marginTop:"20px"},children:[e.jsx("label",{children:"Description (optional)"}),e.jsx("input",{type:"text",className:"description-input",placeholder:"Brief description of this job...",value:m,onChange:t=>v(t.target.value)})]}),e.jsxs("div",{className:"step-actions",children:[e.jsx("button",{className:"btn-secondary",onClick:B,children:"Back"}),e.jsx("button",{className:"btn-primary",disabled:o.length===0||w.length>0,onClick:C,children:"Continue"})]})]},"step-1"),n===2&&e.jsxs(u.div,{variants:S,initial:"initial",animate:"animate",exit:"exit",className:"step-content",children:[e.jsx("h2",{children:"Review & Submit"}),e.jsx("p",{children:"Confirm your submission details"}),e.jsx(_,{}),e.jsxs("div",{className:"review-card",children:[e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{children:"Pipeline"}),e.jsx("p",{style:{fontSize:"15px"},children:l})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{children:"Files"}),o.length===1?e.jsxs("p",{style:{fontSize:"15px"},children:[o[0].name," (",z(o[0].size),")"]}):e.jsxs("div",{children:[e.jsxs("p",{style:{fontSize:"15px",marginBottom:"8px"},children:[o.length," files (",z(F),")"]}),e.jsx("div",{style:{fontSize:"13px",color:"var(--text-dim)"},children:o.map((t,r)=>e.jsxs("div",{style:{fontFamily:"monospace",fontSize:"12px"},children:[t.name," (",z(t.size),")"]},r))})]})]}),m&&e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{children:"Description"}),e.jsx("p",{style:{fontSize:"15px"},children:m})]})]}),e.jsxs("div",{className:"step-actions",children:[e.jsx("button",{className:"btn-secondary",onClick:B,children:"Back"}),e.jsx("button",{className:"btn-primary",onClick:T,children:"Encrypt & Submit"})]})]},"step-2")]})})]})}function z(n){if(n===0)return"0 B";const i=["B","KB","MB","GB"],a=Math.floor(Math.log(n)/Math.log(1024));return`${(n/Math.pow(1024,a)).toFixed(a===0?0:1)} ${i[a]}`}export{ae as Submit};
