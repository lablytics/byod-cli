import{r as d,j as i,L as m,m as g,f as S}from"./index-eBHcrhee.js";import{a as y}from"./useApi-DI9ecT4O.js";import{u as _,P as k}from"./ProgressTracker-CtiyfszE.js";function N(){const[e,r]=d.useState(null),[o,s]=d.useState(!0),[t,j]=d.useState("us-east-1"),[a,x]=d.useState(!1),n=_();d.useEffect(()=>{y("/setup/status").then(r).catch(()=>{}).finally(()=>s(!1))},[]);const f=()=>{n.start("/api/setup/run",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({region:t,force_new:a})})},p=(e==null?void 0:e.authenticated)&&(e==null?void 0:e.aws_configured)&&(e==null?void 0:e.tenant_valid)&&(e==null?void 0:e.kms_key_configured)&&(e==null?void 0:e.registered),u=(e==null?void 0:e.authenticated)&&(e==null?void 0:e.aws_configured)&&(e==null?void 0:e.tenant_valid);if(n.result){const l=n.result;return i.jsxs("div",{className:"success-content",children:[i.jsx("div",{className:"success-icon",children:i.jsxs("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"var(--green)",strokeWidth:"2",children:[i.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),i.jsx("path",{d:"M9 12l2 2 4-4"})]})}),i.jsx("h2",{children:"Setup Complete!"}),i.jsx("p",{style:{color:"var(--text-dim)",marginBottom:"16px"},children:"Your KMS key and IAM role have been configured with attestation enforcement."}),i.jsxs("div",{className:"review-card",style:{textAlign:"left",maxWidth:"600px",margin:"0 auto"},children:[i.jsxs("div",{className:"review-section",children:[i.jsx("h4",{children:"KMS Key ARN"}),i.jsx("p",{style:{fontFamily:"monospace",fontSize:"12px",wordBreak:"break-all"},children:l.kms_key_arn})]}),i.jsxs("div",{className:"review-section",children:[i.jsx("h4",{children:"IAM Role ARN"}),i.jsx("p",{style:{fontFamily:"monospace",fontSize:"12px",wordBreak:"break-all"},children:l.role_arn})]}),i.jsxs("div",{className:"review-section",children:[i.jsx("h4",{children:"Region"}),i.jsx("p",{children:l.region})]}),i.jsxs("div",{className:"review-section",children:[i.jsx("h4",{children:"Security Guarantees"}),i.jsxs("ul",{style:{fontSize:"13px",color:"var(--text-dim)",paddingLeft:"18px",margin:"4px 0 0 0"},children:[i.jsx("li",{children:"Only you can manage/delete the KMS key"}),i.jsx("li",{children:"Only the Nitro Enclave (with PCR0 verification) can decrypt"}),i.jsx("li",{children:"Lablytics operators cannot access your data"})]})]})]}),i.jsxs("div",{className:"success-actions",children:[i.jsx(m,{to:"/",className:"btn-primary",style:{textDecoration:"none"},children:"Go to Home"}),i.jsx(m,{to:"/submit",className:"btn-secondary",style:{textDecoration:"none"},children:"Submit a Job"})]})]})}return i.jsxs(g.div,{variants:S,initial:"initial",animate:"animate",children:[i.jsxs("div",{className:"page-header",children:[i.jsx("h1",{children:"Setup Wizard"}),i.jsx("p",{children:"Configure your AWS KMS key and IAM role for secure data processing"})]}),o?i.jsx("div",{className:"loading",children:"Checking prerequisites..."}):i.jsxs(i.Fragment,{children:[(e==null?void 0:e.tenant_error)&&i.jsx(g.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},style:{background:"rgba(239, 68, 68, 0.08)",border:"1px solid rgba(239, 68, 68, 0.25)",borderRadius:"12px",padding:"20px 24px",marginBottom:"24px"},children:i.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:"12px"},children:[i.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"var(--red)",strokeWidth:"2",style:{flexShrink:0,marginTop:"2px"},children:[i.jsx("circle",{cx:"12",cy:"12",r:"10"}),i.jsx("line",{x1:"12",y1:"8",x2:"12",y2:"12"}),i.jsx("line",{x1:"12",y1:"16",x2:"12.01",y2:"16"})]}),i.jsxs("div",{children:[i.jsx("div",{style:{fontWeight:600,marginBottom:"4px",color:"var(--red)"},children:"Tenant issue detected"}),i.jsx("div",{style:{color:"var(--text-dim)",fontSize:"14px",marginBottom:"12px"},children:e.tenant_error}),i.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.tenant_error.includes("API key")&&i.jsx("div",{className:"cli-hint",style:{display:"inline-block"},children:"byod auth login"}),e.tenant_error.includes("tenant")&&i.jsx("a",{href:"/api/status",onClick:l=>{l.preventDefault(),y("/status").then(h=>{h.api_url&&window.open(h.api_url,"_blank")})},className:"btn-small",children:"Open Dashboard"})]})]})]})}),i.jsxs("div",{className:"card",style:{marginBottom:"24px"},children:[i.jsx("h3",{style:{fontSize:"16px",marginBottom:"16px"},children:"Prerequisites"}),i.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"12px"},children:[i.jsx(c,{label:"API Authentication",ok:e==null?void 0:e.authenticated,hint:"Run 'byod auth login' in your terminal"}),i.jsx(c,{label:"AWS Credentials",ok:e==null?void 0:e.aws_configured,hint:"Configure ~/.aws/credentials or set AWS_ACCESS_KEY_ID",detail:e!=null&&e.aws_account_id?`Account: ${e.aws_account_id}`:void 0}),i.jsx(c,{label:"Tenant Account",ok:e==null?void 0:e.tenant_valid,pending:(e==null?void 0:e.authenticated)&&!(e!=null&&e.tenant_valid)&&!(e!=null&&e.tenant_error),hint:e!=null&&e.tenant_error?e.tenant_error:e!=null&&e.authenticated?"Tenant must exist and be active":"Authenticate first to check tenant status",detail:e!=null&&e.tenant_id?`ID: ${e.tenant_id.slice(0,16)}...`:void 0}),i.jsx(c,{label:"KMS Key",ok:e==null?void 0:e.kms_key_configured,pending:!(e!=null&&e.kms_key_configured)&&(e==null?void 0:e.tenant_valid)&&!(e!=null&&e.kms_key_error),hint:e!=null&&e.kms_key_error?e.kms_key_error:e!=null&&e.kms_key_configured?"":"Will be created during setup",detail:e!=null&&e.kms_key_arn?v(e.kms_key_arn):void 0}),i.jsx(c,{label:"IAM Role",ok:e==null?void 0:e.role_configured,pending:!(e!=null&&e.role_configured)&&(e==null?void 0:e.tenant_valid)&&!(e!=null&&e.role_error),hint:e!=null&&e.role_error?e.role_error:e!=null&&e.role_configured?"":"Will be created during setup",detail:e!=null&&e.role_arn?v(e.role_arn):void 0})]})]}),p?i.jsxs("div",{className:"card",style:{marginBottom:"24px"},children:[i.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",marginBottom:"16px"},children:[i.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"var(--green)",strokeWidth:"2",children:[i.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),i.jsx("path",{d:"M9 12l2 2 4-4"})]}),i.jsxs("div",{children:[i.jsx("div",{style:{fontWeight:600,color:"var(--green)"},children:"Setup is complete!"}),i.jsx("div",{style:{color:"var(--text-dim)",fontSize:"13px"},children:"Your KMS key and IAM role are configured. You can submit jobs."})]})]}),i.jsxs("div",{style:{borderTop:"1px solid var(--border)",paddingTop:"16px"},children:[i.jsx("p",{style:{color:"var(--text-dim)",fontSize:"13px",marginBottom:"12px"},children:"If you've destroyed and recreated your AWS resources, you can re-run setup to create new ones."}),i.jsx("button",{className:"btn-secondary",onClick:()=>x(!0),style:{fontSize:"13px"},children:"Re-run Setup with New Resources"})]})]}):null,u&&(!p||a)&&i.jsxs("div",{className:"card",style:{marginBottom:"24px"},children:[i.jsx("h3",{style:{fontSize:"16px",marginBottom:"16px"},children:"Configuration"}),i.jsxs("div",{className:"input-group",children:[i.jsx("label",{children:"AWS Region"}),i.jsxs("select",{className:"text-input",value:t,onChange:l=>j(l.target.value),style:{maxWidth:"300px"},children:[i.jsx("option",{value:"us-east-1",children:"US East (N. Virginia)"}),i.jsx("option",{value:"us-east-2",children:"US East (Ohio)"}),i.jsx("option",{value:"us-west-1",children:"US West (N. California)"}),i.jsx("option",{value:"us-west-2",children:"US West (Oregon)"}),i.jsx("option",{value:"eu-west-1",children:"EU (Ireland)"}),i.jsx("option",{value:"eu-central-1",children:"EU (Frankfurt)"})]}),i.jsx("div",{className:"input-hint",children:"The AWS region where your KMS key will be created"})]}),((e==null?void 0:e.kms_key_configured)||(e==null?void 0:e.role_configured))&&i.jsx("div",{style:{marginTop:"16px",marginBottom:"16px"},children:i.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"10px",cursor:"pointer",fontSize:"14px"},children:[i.jsx("input",{type:"checkbox",checked:a,onChange:l=>x(l.target.checked),style:{width:"16px",height:"16px",accentColor:"var(--accent)"}}),i.jsxs("span",{children:["Replace existing resources",i.jsx("span",{style:{color:"var(--text-dim)",fontSize:"12px",display:"block"},children:"Delete current KMS key and IAM role, then create new ones. Use this if your AWS resources were destroyed."})]})]})}),a&&i.jsx("div",{style:{background:"rgba(234, 179, 8, 0.08)",border:"1px solid rgba(234, 179, 8, 0.2)",borderRadius:"8px",padding:"12px 16px",marginBottom:"16px",fontSize:"13px",color:"var(--yellow)"},children:"Existing KMS key will be scheduled for deletion (7-day waiting period). A new key and IAM role will be created and registered."}),i.jsx("button",{className:"btn-primary",onClick:f,disabled:n.active,children:n.active?"Running...":a?"Replace & Re-run Setup":"Run Setup"})]}),(n.active||n.error)&&i.jsx(k,{progress:n.progress,error:n.error,label:"Setup Progress"}),!(e!=null&&e.authenticated)&&i.jsxs("div",{className:"card",style:{marginBottom:"24px",textAlign:"center"},children:[i.jsx("p",{style:{color:"var(--text-dim)",marginBottom:"12px"},children:"Authenticate first to get started"}),i.jsx("div",{className:"cli-hint",style:{display:"inline-block"},children:"byod auth login"})]}),(e==null?void 0:e.authenticated)&&!(e!=null&&e.aws_configured)&&i.jsxs("div",{className:"card",style:{marginBottom:"24px",textAlign:"center"},children:[i.jsx("p",{style:{color:"var(--text-dim)",marginBottom:"12px"},children:"AWS credentials are needed to create your KMS key and IAM role"}),i.jsx("div",{className:"cli-hint",style:{display:"inline-block"},children:"aws configure"}),i.jsx("div",{style:{color:"var(--text-dim)",fontSize:"12px",marginTop:"8px"},children:"Or set AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY environment variables"})]})]})]})}function c({label:e,ok:r,pending:o,hint:s,detail:t}){return i.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[i.jsx("div",{style:{width:"24px",height:"24px",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:r?"rgba(34, 197, 94, 0.15)":o?"rgba(234, 179, 8, 0.15)":"rgba(239, 68, 68, 0.15)",color:r?"var(--green)":o?"var(--yellow)":"var(--red)",fontSize:"14px",flexShrink:0},children:r?"✓":o?"•":"✗"}),i.jsxs("div",{style:{minWidth:0},children:[i.jsx("div",{style:{fontWeight:500},children:e}),!r&&s&&i.jsx("div",{style:{fontSize:"12px",color:"var(--text-dim)"},children:s}),t&&i.jsx("div",{style:{fontSize:"11px",color:"var(--text-dim)",fontFamily:"monospace",marginTop:"2px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t})]})]})}function v(e){const r=e.split(":");return r.length>=6?`${r.slice(-1)[0].slice(0,32)}...`:e.slice(0,40)+"..."}export{N as SetupWizard};
