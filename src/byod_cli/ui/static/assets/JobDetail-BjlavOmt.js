import{r,j as e,g as A,m as E,h as H,L as U,A as J}from"./index-B8SBTCI8.js";import{a as D,c as $,d as z}from"./Skeleton-Cg_dwXAZ.js";import{S as P}from"./StatusBadge-CPNlcQHy.js";import{u as _,P as G}from"./ProgressTracker-4PGVOIMw.js";const V=3e3,Z={DEBUG:"var(--text-dim)",INFO:"var(--green)",WARNING:"var(--yellow)",ERROR:"var(--red)",CRITICAL:"var(--red)"},K={orchestrator:"var(--accent)"};function X({jobId:s,jobStatus:l}){const[f,N]=r.useState([]),[j,h]=r.useState(!0),[L,d]=r.useState(null),[c,M]=r.useState(new Set),[t,I]=r.useState(""),[b,k]=r.useState(""),[w,T]=r.useState(!0),u=r.useRef(null),S=r.useRef(null),v=r.useRef(t),R=r.useRef(b);v.current=t,R.current=b;const g=r.useMemo(()=>["pending","processing","downloading","uploading","submitted"].includes(l),[l]),x=r.useCallback(async(i=!1)=>{i&&h(!0);try{const a=new URLSearchParams;a.set("limit","1000"),v.current&&a.set("level",v.current),R.current&&a.set("source",R.current);const W=(await D(`/jobs/${s}/logs?${a}`)).logs.filter(B=>B.source!=="enclave");N(W),d(null)}catch(a){d(a instanceof Error?a.message:"Failed to load logs")}finally{i&&h(!1)}},[s]);r.useEffect(()=>{x(!0)},[x]),r.useEffect(()=>{x(!1)},[t,b,x]),r.useEffect(()=>(g&&(S.current=window.setInterval(()=>x(!1),V)),()=>{S.current&&(clearInterval(S.current),S.current=null)}),[g,x]),r.useEffect(()=>{w&&u.current&&(u.current.scrollTop=u.current.scrollHeight)},[f,w]);const C=i=>{M(a=>{const p=new Set(a);return p.has(i)?p.delete(i):p.add(i),p})},y=i=>{try{const a=new Date(i),p=a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),W=a.getMilliseconds().toString().padStart(3,"0");return`${p}.${W}`}catch{return i}};return j?e.jsx("div",{className:"loading",style:{padding:24},children:"Loading logs..."}):L?e.jsxs("div",{className:"error-message",children:[L,e.jsx("button",{className:"btn-small",onClick:()=>x(!0),style:{marginLeft:12},children:"Retry"})]}):e.jsxs("div",{className:"log-viewer",children:[e.jsxs("div",{style:{display:"flex",gap:12,marginBottom:16,alignItems:"center",flexWrap:"wrap"},children:[e.jsxs("select",{value:t,onChange:i=>I(i.target.value),style:{background:"var(--bg)",border:"1px solid var(--border)",borderRadius:6,padding:"6px 12px",color:"var(--text)",fontSize:13},children:[e.jsx("option",{value:"",children:"All Levels"}),e.jsx("option",{value:"DEBUG",children:"Debug"}),e.jsx("option",{value:"INFO",children:"Info"}),e.jsx("option",{value:"WARNING",children:"Warning"}),e.jsx("option",{value:"ERROR",children:"Error"})]}),e.jsxs("select",{value:b,onChange:i=>k(i.target.value),style:{background:"var(--bg)",border:"1px solid var(--border)",borderRadius:6,padding:"6px 12px",color:"var(--text)",fontSize:13},children:[e.jsx("option",{value:"",children:"All Sources"}),e.jsx("option",{value:"orchestrator",children:"Orchestrator"})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:6,fontSize:13,color:"var(--text-dim)",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:w,onChange:i=>T(i.target.checked)}),"Auto-scroll"]}),e.jsxs("span",{style:{marginLeft:"auto",fontSize:13,color:"var(--text-dim)"},children:[f.length," log",f.length!==1?"s":"",g&&e.jsx("span",{style:{marginLeft:8,color:"var(--green)"},children:"(live)"})]})]}),e.jsx("div",{ref:u,style:{background:"#111318",border:"1px solid var(--border)",borderRadius:8,maxHeight:500,overflowY:"auto",fontFamily:"'SF Mono', 'Fira Code', monospace",fontSize:12,lineHeight:1.5},children:f.length===0?e.jsx("div",{style:{padding:24,color:"var(--text-dim)",textAlign:"center"},children:"No logs available"}):f.map(i=>e.jsxs("div",{style:{padding:"6px 12px",borderBottom:"1px solid var(--border)",display:"flex",gap:8,alignItems:"flex-start"},children:[e.jsx("span",{style:{color:"var(--text-dim)",flexShrink:0},children:y(i.timestamp)}),e.jsx("span",{style:{color:Z[i.level]||"var(--text)",fontWeight:600,width:60,flexShrink:0},children:i.level}),e.jsx("span",{style:{background:"rgba(99, 102, 241, 0.12)",color:K[i.source]||"var(--text-dim)",padding:"1px 6px",borderRadius:3,fontSize:10,flexShrink:0},children:i.source}),e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsx("span",{style:{color:i.level==="ERROR"||i.level==="CRITICAL"?"var(--red)":"var(--text)",wordBreak:"break-word"},children:i.message}),i.metadata&&Object.keys(i.metadata).length>0&&e.jsxs("div",{style:{marginTop:4},children:[e.jsx("button",{onClick:()=>C(i.id),style:{background:"none",border:"none",color:"var(--accent)",cursor:"pointer",padding:0,fontSize:11},children:c.has(i.id)?"[-] Hide details":"[+] Show details"}),c.has(i.id)&&e.jsx("pre",{style:{marginTop:8,padding:8,background:"var(--bg)",borderRadius:4,overflow:"auto",fontSize:11,color:"var(--text-dim)"},children:JSON.stringify(i.metadata,null,2)})]})]})]},i.id))})]})}function F(s){return s<1024?`${s} B`:s<1024*1024?`${(s/1024).toFixed(1)} KB`:`${(s/(1024*1024)).toFixed(1)} MB`}function Y(s){const l=new Date(s),N=new Date().getTime()-l.getTime(),j=Math.floor(N/6e4);if(j<1)return"just now";if(j<60)return`${j}m ago`;const h=Math.floor(j/60);return h<24?`${h}h ago`:`${Math.floor(h/24)}d ago`}function q(s){return s.startsWith("text/html")?"HTML":s==="application/json"?"JSON":s.startsWith("text/")?"TXT":s.startsWith("image/")?"IMG":s==="application/zip"?"ZIP":s==="application/gzip"?"GZ":"BIN"}function Q(s){return s.startsWith("text/html")?{bg:"rgba(99, 102, 241, 0.15)",fg:"var(--accent)"}:s==="application/json"?{bg:"rgba(234, 179, 8, 0.15)",fg:"var(--yellow)"}:s.startsWith("text/")?{bg:"rgba(34, 197, 94, 0.15)",fg:"var(--green)"}:s.startsWith("image/")?{bg:"rgba(139, 92, 246, 0.15)",fg:"var(--purple)"}:{bg:"rgba(255,255,255,0.06)",fg:"var(--text-dim)"}}function re(){const{jobId:s}=A(),[l,f]=r.useState(null),[N,j]=r.useState(!0),[h,L]=r.useState(null),d=_(),[c,M]=r.useState(null),[t,I]=r.useState(null),[b,k]=r.useState(null),[w,T]=r.useState(!1),[u,S]=r.useState("overview");r.useEffect(()=>{if(!s)return;const n=()=>{D(`/jobs/${s}`).then(f).catch(m=>L(m.message)).finally(()=>j(!1))};n();const o=setInterval(n,5e3);return()=>clearInterval(o)},[s]);const v=r.useCallback(()=>{s&&D(`/jobs/${s}/results`).then(n=>{M(n);const o=n.files.find(m=>m.mime.startsWith("text/html"));o&&I(o),S("results")}).catch(()=>{})},[s]);r.useEffect(()=>{v()},[v]),r.useEffect(()=>{d.result&&v()},[d.result,v]),r.useEffect(()=>{if(!t||!s){k(null);return}const n=t.mime.startsWith("text/")||t.mime==="application/json";if(t.mime.startsWith("text/html")){k(null);return}if(!n){k(null);return}T(!0),fetch(`/api/jobs/${s}/results/file?path=${encodeURIComponent(t.path)}`).then(o=>{if(!o.ok)throw new Error(`HTTP ${o.status}`);return o.text()}).then(k).catch(()=>k("Failed to load file content.")).finally(()=>T(!1))},[t,s]);const R=()=>{s&&d.start(`/api/jobs/${s}/get`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})})};if(N)return e.jsxs("div",{children:[e.jsx("div",{style:{marginBottom:"20px"},children:e.jsx($,{width:100,height:14})}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:32},children:[e.jsx($,{width:200,height:28}),e.jsx($,{width:80,height:24,style:{borderRadius:12}})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12,marginBottom:24},children:[e.jsx(z,{lines:2}),e.jsx(z,{lines:2}),e.jsx(z,{lines:2})]}),e.jsx(z,{lines:6})]});if(h)return e.jsx("div",{className:"error-message",children:h});if(!l)return e.jsx("div",{className:"error-message",children:"Job not found"});const g=t==null?void 0:t.mime.startsWith("text/html"),x=t&&!g&&(t.mime.startsWith("text/")||t.mime==="application/json"),C=t==null?void 0:t.mime.startsWith("image/"),y=t&&s?`/api/jobs/${s}/results/file?path=${encodeURIComponent(t.path)}`:null,i=y?`${y}&download=true`:null,a=c&&c.files.length>0,p=l.status.toLowerCase()==="completed",W=l.status.toLowerCase()==="failed",B=["pending","processing","downloading","uploading","submitted"].includes(l.status.toLowerCase());return e.jsxs(E.div,{variants:H,initial:"initial",animate:"animate",children:[e.jsx("div",{style:{marginBottom:"20px"},children:e.jsxs(U,{to:"/jobs",className:"job-back-link",children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M19 12H5"}),e.jsx("path",{d:"M12 19l-7-7 7-7"})]}),"Back to Jobs"]})}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:"28px"},children:[e.jsxs("div",{style:{flex:1,minWidth:0},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px",marginBottom:"8px",flexWrap:"wrap"},children:[e.jsx("h1",{style:{fontSize:"22px",fontWeight:700,margin:0},children:"Job Details"}),e.jsx(P,{status:l.status}),B&&e.jsxs("span",{className:"job-live-indicator",children:[e.jsx("span",{className:"job-live-dot"}),"Live"]})]}),e.jsx("p",{style:{fontFamily:"'SF Mono', 'Fira Code', monospace",fontSize:"13px",color:"var(--text-dim)",margin:0,overflow:"hidden",textOverflow:"ellipsis"},children:l.job_id})]}),p&&e.jsx("button",{className:"btn-primary",onClick:R,disabled:d.active,style:{flexShrink:0,marginLeft:"16px"},children:d.active?"Retrieving...":a?"Re-download":"Get Results"})]}),(d.active||d.error)&&e.jsx("div",{style:{marginBottom:"24px"},children:e.jsx(G,{progress:d.progress,error:d.error,label:"Retrieving Results"})}),e.jsxs("div",{className:"job-info-row",children:[e.jsxs("div",{className:"job-info-card",children:[e.jsx("div",{className:"job-info-label",children:"Pipeline"}),e.jsxs("div",{className:"job-info-value",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"var(--accent)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{flexShrink:0},children:[e.jsx("path",{d:"M12 2L2 7l10 5 10-5-10-5z"}),e.jsx("path",{d:"M2 17l10 5 10-5"}),e.jsx("path",{d:"M2 12l10 5 10-5"})]}),e.jsx("span",{children:l.plugin_name})]})]}),e.jsxs("div",{className:"job-info-card",children:[e.jsx("div",{className:"job-info-label",children:"Submitted"}),e.jsxs("div",{className:"job-info-value",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"var(--text-dim)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{flexShrink:0},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M12 6v6l4 2"})]}),e.jsx("span",{title:new Date(l.created_at).toLocaleString(),children:Y(l.created_at)})]})]}),W?e.jsxs("div",{className:"job-info-card",style:{borderColor:"rgba(239, 68, 68, 0.3)"},children:[e.jsx("div",{className:"job-info-label",style:{color:"var(--red)"},children:"Error"}),e.jsx("div",{className:"job-info-value",style:{color:"var(--red)",fontSize:"13px"},children:l.description||"Unknown error"})]}):e.jsxs("div",{className:"job-info-card",children:[e.jsx("div",{className:"job-info-label",children:a?"Results":"Description"}),e.jsx("div",{className:"job-info-value",children:a?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"var(--green)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{flexShrink:0},children:[e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),e.jsx("path",{d:"M9 12l2 2 4-4"})]}),e.jsxs("span",{style:{color:"var(--green)"},children:[c.files.length," file",c.files.length!==1?"s":""," decrypted"]})]}):e.jsx("span",{style:{color:"var(--text-dim)"},children:l.description||"No description"})})]})]}),e.jsx("div",{className:"job-tab-bar",children:[{key:"overview",label:"Overview"},...a?[{key:"results",label:`Results (${c.files.length})`}]:[],{key:"logs",label:"Logs"}].map(n=>e.jsx("button",{onClick:()=>S(n.key),className:`job-tab-btn ${u===n.key?"active":""}`,children:n.label},n.key))}),e.jsxs(J,{mode:"wait",children:[u==="overview"&&e.jsxs(E.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},transition:{duration:.15},children:[l.description&&e.jsxs("div",{className:"card",style:{marginBottom:"16px"},children:[e.jsx("div",{className:"job-section-header",children:"Description"}),e.jsx("div",{style:{fontSize:"14px",lineHeight:1.6},children:l.description})]}),l.timeline&&l.timeline.length>0&&e.jsxs("div",{className:"card",style:{marginBottom:"16px"},children:[e.jsx("div",{className:"job-section-header",children:"Timeline"}),e.jsx("div",{className:"job-timeline",children:l.timeline.map((n,o)=>{var O;const m=o===(((O=l.timeline)==null?void 0:O.length)??0)-1;return e.jsxs("div",{className:"job-timeline-item",children:[e.jsxs("div",{className:"job-timeline-dot-col",children:[e.jsx("div",{className:`job-timeline-dot ${m&&B?"active":m?"completed":""}`}),!m&&e.jsx("div",{className:"job-timeline-line"})]}),e.jsxs("div",{style:{flex:1},children:[e.jsx("div",{style:{fontWeight:500,textTransform:"capitalize",fontSize:"14px"},children:n.phase}),e.jsx("div",{style:{fontSize:"12px",color:"var(--text-dim)",marginTop:"2px"},children:new Date(n.timestamp).toLocaleString()})]})]},o)})})]}),e.jsxs("div",{className:"job-cli-hint",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"var(--accent)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",style:{flexShrink:0},children:[e.jsx("polyline",{points:"4 17 10 11 4 5"}),e.jsx("line",{x1:"12",y1:"19",x2:"20",y2:"19"})]}),e.jsxs("code",{children:["byod status ",l.job_id]})]})]},"overview"),u==="results"&&a&&e.jsx(E.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},transition:{duration:.15},children:e.jsxs("div",{className:"results-container",children:[e.jsxs("div",{className:"results-header",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"var(--green)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"}),e.jsx("path",{d:"M9 12l2 2 4-4"})]}),e.jsx("span",{style:{fontSize:"13px",fontWeight:600,color:"var(--green)"},children:"Decrypted locally"})]}),e.jsxs("span",{style:{fontSize:"12px",color:"var(--text-dim)"},children:[c.files.length," file",c.files.length!==1?"s":""," ","(",F(c.files.reduce((n,o)=>n+o.size,0))," total)"]})]}),e.jsxs("div",{className:"results-split",children:[e.jsx("div",{className:"results-sidebar",children:c.files.map(n=>{const o=Q(n.mime),m=(t==null?void 0:t.path)===n.path;return e.jsxs("button",{onClick:()=>I(n),className:`results-file-btn ${m?"selected":""}`,children:[e.jsx("span",{className:"results-file-icon",style:{background:o.bg,color:o.fg},children:q(n.mime)}),e.jsxs("div",{style:{minWidth:0,flex:1},children:[e.jsx("div",{className:"results-file-name",children:n.name}),n.path!==n.name&&e.jsx("div",{className:"results-file-path",children:n.path}),e.jsx("div",{className:"results-file-size",children:F(n.size)})]})]},n.path)})}),e.jsxs("div",{className:"results-viewer",children:[!t&&e.jsxs("div",{className:"results-empty",children:[e.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"var(--border)",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14 2 14 8 20 8"}),e.jsx("line",{x1:"16",y1:"13",x2:"8",y2:"13"}),e.jsx("line",{x1:"16",y1:"17",x2:"8",y2:"17"})]}),e.jsx("div",{style:{marginTop:"12px"},children:"Select a file to preview"})]}),t&&w&&e.jsxs("div",{className:"results-empty",children:[e.jsx("div",{className:"loading-spinner",style:{width:24,height:24}}),e.jsx("div",{style:{marginTop:"12px"},children:"Loading..."})]}),t&&g&&y&&e.jsx("iframe",{src:y,title:t.name,style:{width:"100%",height:"100%",border:"none",background:"#fff",borderRadius:"0 0 10px 0"}}),t&&x&&b!==null&&!w&&e.jsx("pre",{className:"results-text-content",children:b}),t&&C&&y&&e.jsx("div",{className:"results-image-container",children:e.jsx("img",{src:y,alt:t.name,style:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain",borderRadius:"4px"}})}),t&&!g&&!x&&!C&&!w&&e.jsxs("div",{className:"results-empty",children:[e.jsxs("svg",{width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"var(--border)",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),e.jsxs("div",{style:{marginTop:"12px"},children:["Binary file (",F(t.size),")"]}),i&&e.jsxs("a",{href:i,download:t.name,className:"btn-primary",style:{textDecoration:"none",marginTop:"12px",fontSize:"13px",padding:"8px 20px"},children:["Download ",t.name]})]}),t&&i&&(g||x||C)&&e.jsxs("a",{href:i,download:t.name,className:"results-download-btn",children:[e.jsxs("svg",{width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",y1:"15",x2:"12",y2:"3"})]}),"Download"]})]})]})]})},"results"),u==="logs"&&e.jsx(E.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:-8},transition:{duration:.15},children:e.jsx("div",{className:"card",children:e.jsx(X,{jobId:l.job_id,jobStatus:l.status})})},"logs")]})]})}export{re as JobDetail};
