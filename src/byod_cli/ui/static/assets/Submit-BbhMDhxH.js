import{r as c,j as e,u as L,L as I,A as T,m as N,b as F,c as W}from"./index-eBHcrhee.js";import{a as w}from"./useApi-DI9ecT4O.js";import{u as J,P as G}from"./ProgressTracker-CtiyfszE.js";function B(n){if(n===0)return"0 B";const r=["B","KB","MB","GB"],l=Math.floor(Math.log(n)/Math.log(1024));return`${(n/Math.pow(1024,l)).toFixed(l===0?0:1)} ${r[l]}`}function H({onFilesSelect:n,files:r,onClear:l,onRemove:g,accept:j,multiple:d=!0}){const[x,m]=c.useState(!1),a=c.useRef(null),u=c.useCallback(s=>{s.preventDefault(),m(!1);const o=Array.from(s.dataTransfer.files);o.length>0&&n(d?[...r,...o]:[o[0]])},[n,r,d]),h=c.useCallback(s=>{const o=Array.from(s.target.files||[]);o.length>0&&n(d?[...r,...o]:[o[0]]),s.target.value=""},[n,r,d]),v=r.reduce((s,o)=>s+o.size,0);return r.length>0?e.jsxs("div",{className:"file-drop-zone has-files",children:[e.jsx("div",{className:"file-list",children:r.map((s,o)=>e.jsxs("div",{className:"file-item",children:[e.jsxs("div",{className:"file-info",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"var(--accent)",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"}),e.jsx("polyline",{points:"14,2 14,8 20,8"})]}),e.jsx("span",{className:"file-name",children:s.name}),e.jsx("span",{className:"file-size",children:B(s.size)})]}),e.jsx("button",{className:"file-remove",onClick:()=>g(o),title:"Remove file",children:"×"})]},`${s.name}-${o}`))}),e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"8px 16px",borderTop:"1px solid var(--border)",fontSize:"12px",color:"var(--text-dim)"},children:[e.jsxs("span",{children:[r.length," file",r.length!==1?"s":""," (",B(v),")"]}),e.jsxs("div",{style:{display:"flex",gap:"12px"},children:[d&&e.jsx("button",{onClick:()=>{var s;return(s=a.current)==null?void 0:s.click()},style:{background:"none",border:"none",color:"var(--accent)",cursor:"pointer",fontSize:"12px",padding:0},children:"+ Add more"}),e.jsx("button",{onClick:l,style:{background:"none",border:"none",color:"var(--red)",cursor:"pointer",fontSize:"12px",padding:0},children:"Clear all"})]})]}),e.jsx("input",{ref:a,type:"file",style:{display:"none"},accept:j,multiple:d,onChange:h})]}):e.jsxs("div",{className:`file-drop-zone ${x?"dragging":""}`,onDragOver:s=>{s.preventDefault(),m(!0)},onDragLeave:()=>m(!1),onDrop:u,onClick:()=>{var s;return(s=a.current)==null?void 0:s.click()},children:[e.jsx("input",{ref:a,type:"file",style:{display:"none"},accept:j,multiple:d,onChange:h}),e.jsxs("div",{className:"drop-zone-content",children:[e.jsxs("svg",{className:"drop-zone-icon",width:"40",height:"40",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"17,8 12,3 7,8"}),e.jsx("line",{x1:"12",y1:"3",x2:"12",y2:"15"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"drop-zone-primary",children:["Drop your file",d?"s":""," here or click to browse"]}),e.jsx("div",{className:"drop-zone-secondary",children:d?"Select one or more files":"Supports any file format"})]}),e.jsx("div",{className:"drop-zone-hint",children:"Files will be encrypted locally with AES-256-GCM before upload"})]})]})}function C(){return e.jsxs("div",{className:"security-notice",children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"4px"},children:[e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"var(--green)",strokeWidth:"2",children:e.jsx("path",{d:"M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"})}),e.jsx("strong",{children:"Zero-knowledge encryption"})]}),e.jsx("span",{style:{color:"var(--text-dim)"},children:"Your data is encrypted on this machine using your AWS KMS key before upload. Neither Lablytics nor anyone else can access your plaintext data. Only the cryptographically attested Nitro Enclave can decrypt it for processing."})]})}const M=["Pipeline","Files","Review"];function V(){const[n,r]=c.useState(0),[l,g]=c.useState(1),[j,d]=c.useState([]),[x,m]=c.useState(""),[a,u]=c.useState([]),[h,v]=c.useState(""),[s,o]=c.useState(null),[D,_]=c.useState(!0),A=L(),p=J();c.useEffect(()=>{w("/status").then(o).catch(()=>{}).finally(()=>_(!1))},[]);const f=(s==null?void 0:s.authenticated)&&(s==null?void 0:s.tenant_valid)&&(s==null?void 0:s.kms_key_configured)&&(s==null?void 0:s.role_configured);c.useEffect(()=>{f&&w("/plugins").then(d).catch(()=>{})},[f]);const S=()=>{g(1),r(i=>Math.min(i+1,M.length-1))},z=()=>{g(-1),r(i=>Math.max(i-1,0))},E=i=>{u(t=>t.filter((b,$)=>$!==i))},P=async()=>{if(a.length===0||!x)return;const i=new FormData;for(const t of a)i.append("files",t);i.append("plugin",x),i.append("description",h),p.start("/api/submit",{method:"POST",body:i})},R=a.reduce((i,t)=>i+t.size,0),y=l>0?F:W;if(p.result){const i=p.result;return e.jsxs("div",{className:"success-content",children:[e.jsx("div",{className:"success-icon",children:e.jsxs("svg",{width:"64",height:"64",viewBox:"0 0 24 24",fill:"none",stroke:"var(--green)",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M9 12l2 2 4-4"})]})}),e.jsx("h2",{children:"Job Submitted!"}),e.jsx("div",{className:"job-id",children:e.jsx("code",{style:{background:"var(--surface)",padding:"4px 12px",borderRadius:"6px",border:"1px solid var(--border)"},children:i.job_id})}),e.jsx("p",{style:{color:"var(--text-dim)",marginBottom:"24px"},children:"Your data was encrypted locally and submitted for processing."}),e.jsxs("div",{className:"success-actions",children:[e.jsx("button",{className:"btn-primary",onClick:()=>A(`/jobs/${i.job_id}`),children:"View Job"}),e.jsx("button",{className:"btn-secondary",onClick:()=>{p.reset(),r(0),u([]),m(""),v("")},children:"Submit Another"})]})]})}if(p.active||p.error)return e.jsxs("div",{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Submitting Job"}),e.jsx("p",{children:"Encrypting and uploading your data..."})]}),e.jsx(C,{}),e.jsx(G,{progress:p.progress,error:p.error,label:"Submission Progress"}),p.error&&e.jsx("div",{style:{marginTop:"16px"},children:e.jsx("button",{className:"btn-secondary",onClick:p.reset,children:"Try Again"})})]});if(D)return e.jsxs("div",{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Submit Job"}),e.jsx("p",{children:"Encrypt and submit data for secure processing"})]}),e.jsx("div",{className:"loading",children:"Checking prerequisites..."})]});if(!f){const i=[];return s!=null&&s.authenticated||i.push("Not authenticated"),s!=null&&s.authenticated&&!(s!=null&&s.tenant_valid)&&i.push((s==null?void 0:s.tenant_error)||"Tenant is not active"),s!=null&&s.kms_key_configured||i.push((s==null?void 0:s.kms_key_error)||"KMS key not configured"),s!=null&&s.role_configured||i.push((s==null?void 0:s.role_error)||"IAM role not configured"),e.jsxs("div",{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Submit Job"}),e.jsx("p",{children:"Encrypt and submit data for secure processing"})]}),e.jsxs("div",{className:"card",style:{textAlign:"center",padding:"48px 24px"},children:[e.jsxs("svg",{width:"48",height:"48",viewBox:"0 0 24 24",fill:"none",stroke:"var(--yellow)",strokeWidth:"2",style:{marginBottom:"16px"},children:[e.jsx("path",{d:"M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"}),e.jsx("line",{x1:"12",y1:"9",x2:"12",y2:"13"}),e.jsx("line",{x1:"12",y1:"17",x2:"12.01",y2:"17"})]}),e.jsx("h2",{style:{marginBottom:"8px"},children:"Setup Required"}),e.jsx("p",{style:{color:"var(--text-dim)",marginBottom:"20px",maxWidth:"400px",margin:"0 auto 20px"},children:"All prerequisites must be met before you can submit jobs."}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"8px",alignItems:"center",marginBottom:"24px"},children:i.map(t=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",fontSize:"14px",color:"var(--red)"},children:[e.jsx("span",{style:{fontSize:"12px"},children:"✗"}),t]},t))}),e.jsx(I,{to:"/setup",className:"btn-primary",style:{textDecoration:"none"},children:"Go to Setup"})]})]})}return e.jsxs("div",{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Submit Job"}),e.jsx("p",{children:"Encrypt and submit data for secure processing"})]}),e.jsx("div",{className:"wizard-steps",children:M.map((i,t)=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px"},children:[t>0&&e.jsx("div",{className:"step-connector"}),e.jsxs("div",{className:`wizard-step ${t===n?"active":t<n?"completed":""}`,children:[e.jsx("div",{className:"step-number",children:t<n?"✓":t+1}),e.jsx("span",{className:"step-label",children:i})]})]},i))}),e.jsx("div",{className:"wizard-content",children:e.jsxs(T,{mode:"wait",children:[n===0&&e.jsxs(N.div,{variants:y,initial:"initial",animate:"animate",exit:"exit",className:"step-content",children:[e.jsx("h2",{children:"Select Pipeline"}),e.jsx("p",{children:"Choose the analysis pipeline for your data"}),j.length===0?e.jsx("div",{className:"loading",children:"Loading pipelines..."}):e.jsx("div",{className:"pipeline-grid",children:j.map(i=>{var t;return e.jsxs("div",{className:`pipeline-card ${x===i.name?"selected":""}`,onClick:()=>m(i.name),children:[e.jsx("h3",{children:i.name}),e.jsx("div",{className:"desc",children:i.description}),(t=i.tags)==null?void 0:t.map(b=>e.jsx("span",{className:"tag",children:b},b)),i.input_type&&e.jsxs("div",{style:{marginTop:"8px",fontSize:"12px",color:"var(--text-dim)"},children:["Input: ",i.input_type]})]},i.name)})}),e.jsx("div",{className:"step-actions",children:e.jsx("button",{className:"btn-primary",disabled:!x,onClick:S,children:"Continue"})})]},"step-0"),n===1&&e.jsxs(N.div,{variants:y,initial:"initial",animate:"animate",exit:"exit",className:"step-content",children:[e.jsx("h2",{children:"Upload Files"}),e.jsx("p",{children:"Select the file(s) you want to process"}),e.jsx(H,{files:a,onFilesSelect:u,onClear:()=>u([]),onRemove:E}),e.jsxs("div",{className:"input-group",style:{marginTop:"20px"},children:[e.jsx("label",{children:"Description (optional)"}),e.jsx("input",{type:"text",className:"description-input",placeholder:"Brief description of this job...",value:h,onChange:i=>v(i.target.value)})]}),e.jsxs("div",{className:"step-actions",children:[e.jsx("button",{className:"btn-secondary",onClick:z,children:"Back"}),e.jsx("button",{className:"btn-primary",disabled:a.length===0,onClick:S,children:"Continue"})]})]},"step-1"),n===2&&e.jsxs(N.div,{variants:y,initial:"initial",animate:"animate",exit:"exit",className:"step-content",children:[e.jsx("h2",{children:"Review & Submit"}),e.jsx("p",{children:"Confirm your submission details"}),e.jsx(C,{}),e.jsxs("div",{className:"review-card",children:[e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{children:"Pipeline"}),e.jsx("p",{style:{fontSize:"15px"},children:x})]}),e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{children:"Files"}),a.length===1?e.jsxs("p",{style:{fontSize:"15px"},children:[a[0].name," (",k(a[0].size),")"]}):e.jsxs("div",{children:[e.jsxs("p",{style:{fontSize:"15px",marginBottom:"8px"},children:[a.length," files (",k(R),")"]}),e.jsx("div",{style:{fontSize:"13px",color:"var(--text-dim)"},children:a.map((i,t)=>e.jsxs("div",{style:{fontFamily:"monospace",fontSize:"12px"},children:[i.name," (",k(i.size),")"]},t))})]})]}),h&&e.jsxs("div",{className:"review-section",children:[e.jsx("h4",{children:"Description"}),e.jsx("p",{style:{fontSize:"15px"},children:h})]})]}),e.jsxs("div",{className:"step-actions",children:[e.jsx("button",{className:"btn-secondary",onClick:z,children:"Back"}),e.jsx("button",{className:"btn-primary",onClick:P,children:"Encrypt & Submit"})]})]},"step-2")]})})]})}function k(n){if(n===0)return"0 B";const r=["B","KB","MB","GB"],l=Math.floor(Math.log(n)/Math.log(1024));return`${(n/Math.pow(1024,l)).toFixed(l===0?0:1)} ${r[l]}`}export{V as Submit};
